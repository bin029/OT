<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰“å¡åœºæ™¯æµ‹è¯•éªŒè¯</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }
        .test-section h2 {
            margin-top: 0;
            color: #333;
            font-size: 18px;
        }
        .test-case {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        .test-case-title {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }
        .test-case-details {
            font-size: 14px;
            color: #6c757d;
            margin: 5px 0;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
        .test-pass {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-fail {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .summary {
            margin-top: 30px;
            padding: 20px;
            background: #e8f5e9;
            border-radius: 8px;
            text-align: center;
        }
        .summary h3 {
            margin-top: 0;
            color: #2e7d32;
        }
        .summary-stats {
            font-size: 18px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“‹ æ‰“å¡åœºæ™¯æµ‹è¯•éªŒè¯</h1>
        <div id="testResults"></div>
        <div id="summary" class="summary" style="display:none;">
            <h3>æµ‹è¯•æ€»ç»“</h3>
            <div id="summaryStats" class="summary-stats"></div>
        </div>
    </div>

    <script>
        // å¤åˆ¶TimeRecorderçš„æ ¸å¿ƒè®¡ç®—é€»è¾‘ç”¨äºæµ‹è¯•
        class TestTimeRecorder {
            constructor() {
                this.workdayOverrides = {};
            }

            calculateTimeDifference(startTime, endTime) {
                const diffMs = endTime.getTime() - startTime.getTime();
                return Math.round(diffMs / (1000 * 60));
            }

            shouldCalculateAsWorkday(dateKey) {
                const date = new Date(dateKey + 'T00:00:00');
                const dayOfWeek = date.getDay();
                if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                    return true;
                }
                return this.workdayOverrides[dateKey] === true;
            }

            calculateOvertime(dayRecords, dateKey) {
                const date = new Date(dateKey + 'T00:00:00');
                let totalOvertimeMinutes = 0;

                if (dayRecords.first && dayRecords.last) {
                    const actualStartTime = new Date(dayRecords.first.date);
                    const actualEndTime = new Date(dayRecords.last.date);

                    if (this.shouldCalculateAsWorkday(dateKey)) {
                        const standardStartTime = new Date(dateKey + 'T09:00:00');
                        const overtimeStartTime = new Date(dateKey + 'T18:30:00');

                        const overtimeAfter1830 = Math.max(0, this.calculateTimeDifference(overtimeStartTime, actualEndTime));
                        const lateMinutes = Math.max(0, this.calculateTimeDifference(standardStartTime, actualStartTime));
                        const hasReachedOvertimeStart = actualEndTime >= overtimeStartTime;

                        if (hasReachedOvertimeStart) {
                            totalOvertimeMinutes = overtimeAfter1830 - lateMinutes;
                        } else {
                            const earlyLeaveMinutes = Math.max(0, this.calculateTimeDifference(actualEndTime, overtimeStartTime));
                            totalOvertimeMinutes = -earlyLeaveMinutes - lateMinutes;
                        }
                    } else {
                        totalOvertimeMinutes = this.calculateTimeDifference(actualStartTime, actualEndTime);
                    }
                }

                if (dayRecords.manualOvertime !== undefined && dayRecords.manualOvertime !== null && dayRecords.manualOvertime !== 0) {
                    totalOvertimeMinutes += dayRecords.manualOvertime * 60;
                }

                return totalOvertimeMinutes;
            }

            formatTimeDisplay(minutes) {
                const hours = Math.floor(Math.abs(minutes) / 60);
                const mins = Math.abs(minutes) % 60;
                const sign = minutes < 0 ? '-' : '';
                return `${sign}${hours}:${String(mins).padStart(2, '0')}`;
            }
        }

        function createTestRecord(dateStr, startTime, endTime, manualOvertime = 0) {
            const record = {};
            if (startTime) {
                record.first = { date: new Date(`${dateStr}T${startTime}:00`) };
            }
            if (endTime) {
                record.last = { date: new Date(`${dateStr}T${endTime}:00`) };
            }
            if (manualOvertime !== 0) {
                record.manualOvertime = manualOvertime;
            }
            return record;
        }

        function getDayOfWeek(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            const days = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
            return days[date.getDay()];
        }

        const recorder = new TestTimeRecorder();
        let passedTests = 0;
        let failedTests = 0;

        const testScenarios = [
            {
                category: 'å·¥ä½œæ—¥æ­£å¸¸åœºæ™¯',
                tests: [
                    {
                        name: 'å‡†æ—¶ä¸Šç­å‡†æ—¶ä¸‹ç­ (9:00-18:30)',
                        date: '2025-01-20',
                        start: '09:00',
                        end: '18:30',
                        manual: 0,
                        expected: 0,
                        description: 'æ ‡å‡†å·¥ä½œæ—¶é—´ï¼Œæ— åŠ ç­'
                    },
                    {
                        name: 'å‡†æ—¶ä¸Šç­åŠ ç­1å°æ—¶ (9:00-19:30)',
                        date: '2025-01-20',
                        start: '09:00',
                        end: '19:30',
                        manual: 0,
                        expected: 60,
                        description: 'ä¸‹ç­æ—¶é—´è¶…è¿‡18:30ï¼ŒåŠ ç­1å°æ—¶'
                    },
                    {
                        name: 'å‡†æ—¶ä¸Šç­åŠ ç­2.5å°æ—¶ (9:00-21:00)',
                        date: '2025-01-20',
                        start: '09:00',
                        end: '21:00',
                        manual: 0,
                        expected: 150,
                        description: 'åŠ ç­2.5å°æ—¶'
                    }
                ]
            },
            {
                category: 'å·¥ä½œæ—¥è¿Ÿåˆ°åœºæ™¯',
                tests: [
                    {
                        name: 'è¿Ÿåˆ°1å°æ—¶å‡†æ—¶ä¸‹ç­ (10:00-18:30)',
                        date: '2025-01-20',
                        start: '10:00',
                        end: '18:30',
                        manual: 0,
                        expected: -60,
                        description: 'è¿Ÿåˆ°1å°æ—¶ï¼Œæ‰£é™¤60åˆ†é’Ÿ'
                    },
                    {
                        name: 'è¿Ÿåˆ°30åˆ†é’ŸåŠ ç­1å°æ—¶ (9:30-19:30)',
                        date: '2025-01-20',
                        start: '09:30',
                        end: '19:30',
                        manual: 0,
                        expected: 30,
                        description: 'è¿Ÿåˆ°30åˆ†é’Ÿï¼ŒåŠ ç­1å°æ—¶ï¼Œå‡€åŠ ç­30åˆ†é’Ÿ'
                    },
                    {
                        name: 'ç”¨æˆ·æåˆ°çš„åœºæ™¯ï¼šè¿Ÿåˆ°3å°æ—¶æ—©é€€1.5å°æ—¶ (12:00-17:00)',
                        date: '2025-01-20',
                        start: '12:00',
                        end: '17:00',
                        manual: 0,
                        expected: -270,
                        description: 'è¿Ÿåˆ°3å°æ—¶(180åˆ†é’Ÿ) + æ—©é€€1.5å°æ—¶(90åˆ†é’Ÿ) = -270åˆ†é’Ÿ'
                    }
                ]
            },
            {
                category: 'å·¥ä½œæ—¥æ—©é€€åœºæ™¯',
                tests: [
                    {
                        name: 'å‡†æ—¶ä¸Šç­æ—©é€€1å°æ—¶ (9:00-17:30)',
                        date: '2025-01-20',
                        start: '09:00',
                        end: '17:30',
                        manual: 0,
                        expected: -60,
                        description: 'æ—©é€€1å°æ—¶ï¼Œæ‰£é™¤60åˆ†é’Ÿ'
                    },
                    {
                        name: 'è¿Ÿåˆ°1å°æ—¶æ—©é€€30åˆ†é’Ÿ (10:00-18:00)',
                        date: '2025-01-20',
                        start: '10:00',
                        end: '18:00',
                        manual: 0,
                        expected: -90,
                        description: 'è¿Ÿåˆ°60åˆ†é’Ÿ + æ—©é€€30åˆ†é’Ÿ = -90åˆ†é’Ÿ'
                    }
                ]
            },
            {
                category: 'å‘¨æœ«åœºæ™¯',
                tests: [
                    {
                        name: 'å‘¨æœ«å·¥ä½œ8å°æ—¶ (9:00-17:00)',
                        date: '2025-01-18',
                        start: '09:00',
                        end: '17:00',
                        manual: 0,
                        expected: 480,
                        description: 'å‘¨æœ«å…¨å¤©ç®—åŠ ç­ï¼Œ8å°æ—¶ = 480åˆ†é’Ÿ'
                    },
                    {
                        name: 'å‘¨æœ«å…¨å¤©å·¥ä½œ (8:00-20:00)',
                        date: '2025-01-19',
                        start: '08:00',
                        end: '20:00',
                        manual: 0,
                        expected: 720,
                        description: 'å‘¨æœ«å·¥ä½œ12å°æ—¶ = 720åˆ†é’Ÿ'
                    }
                ]
            },
            {
                category: 'æ‰‹åŠ¨è¡¥å½•åœºæ™¯',
                tests: [
                    {
                        name: 'åªæœ‰æ‰‹åŠ¨è¡¥å½•2å°æ—¶',
                        date: '2025-01-20',
                        start: null,
                        end: null,
                        manual: 2,
                        expected: 120,
                        description: 'æ— æ‰“å¡è®°å½•ï¼Œè¡¥å½•2å°æ—¶ = 120åˆ†é’Ÿ'
                    },
                    {
                        name: 'è‡ªåŠ¨æ‰“å¡1å°æ—¶ + æ‰‹åŠ¨è¡¥å½•1å°æ—¶',
                        date: '2025-01-20',
                        start: '09:00',
                        end: '19:30',
                        manual: 1,
                        expected: 120,
                        description: 'è‡ªåŠ¨60åˆ†é’Ÿ + è¡¥å½•60åˆ†é’Ÿ = 120åˆ†é’Ÿ'
                    },
                    {
                        name: 'è´Ÿæ•°è¡¥å½•ï¼ˆè°ƒä¼‘æ¶ˆè€—ï¼‰-2å°æ—¶',
                        date: '2025-01-20',
                        start: null,
                        end: null,
                        manual: -2,
                        expected: -120,
                        description: 'è°ƒä¼‘æ¶ˆè€—2å°æ—¶ = -120åˆ†é’Ÿ'
                    },
                    {
                        name: 'è‡ªåŠ¨æ‰“å¡1å°æ—¶ + è°ƒä¼‘æ¶ˆè€—2å°æ—¶',
                        date: '2025-01-20',
                        start: '09:00',
                        end: '19:30',
                        manual: -2,
                        expected: -60,
                        description: 'è‡ªåŠ¨60åˆ†é’Ÿ - è°ƒä¼‘120åˆ†é’Ÿ = -60åˆ†é’Ÿ'
                    },
                    {
                        name: 'è°ƒä¼‘æŠµæ¶ˆè‡ªåŠ¨åŠ ç­',
                        date: '2025-01-20',
                        start: '09:00',
                        end: '19:30',
                        manual: -1,
                        expected: 0,
                        description: 'è‡ªåŠ¨60åˆ†é’Ÿ - è°ƒä¼‘60åˆ†é’Ÿ = 0åˆ†é’Ÿ'
                    }
                ]
            },
            {
                category: 'èŠ‚å‡æ—¥è°ƒä¼‘æ—¥åœºæ™¯',
                tests: [
                    {
                        name: 'å‘¨æœ«è®¾ç½®ä¸ºè°ƒä¼‘æ—¥ï¼ŒæŒ‰å·¥ä½œæ—¥è§„åˆ™è®¡ç®—',
                        date: '2025-01-18',
                        start: '09:00',
                        end: '19:30',
                        manual: 0,
                        expected: 60,
                        description: 'è°ƒä¼‘æ—¥æŒ‰å·¥ä½œæ—¥è§„åˆ™ï¼ŒåŠ ç­1å°æ—¶',
                        isWorkdayOverride: true
                    }
                ]
            }
        ];

        function runTests() {
            const resultsDiv = document.getElementById('testResults');
            let html = '';

            testScenarios.forEach(section => {
                html += `<div class="test-section">
                    <h2>${section.category}</h2>`;

                section.tests.forEach(test => {
                    if (test.isWorkdayOverride) {
                        recorder.workdayOverrides[test.date] = true;
                    }

                    const record = createTestRecord(test.date, test.start, test.end, test.manual);
                    const actual = recorder.calculateOvertime(record, test.date);
                    const passed = actual === test.expected;
                    const display = recorder.formatTimeDisplay(actual);
                    const expectedDisplay = recorder.formatTimeDisplay(test.expected);

                    if (passed) {
                        passedTests++;
                    } else {
                        failedTests++;
                    }

                    html += `
                        <div class="test-case">
                            <div class="test-case-title">${test.name}</div>
                            <div class="test-case-details">
                                <div>æ—¥æœŸ: ${test.date} (${getDayOfWeek(test.date)})</div>
                                ${test.start ? `<div>ä¸Šç­: ${test.start}</div>` : ''}
                                ${test.end ? `<div>ä¸‹ç­: ${test.end}</div>` : ''}
                                ${test.manual !== 0 ? `<div>è¡¥å½•: ${test.manual}å°æ—¶</div>` : ''}
                                <div>${test.description}</div>
                            </div>
                            <div class="test-result ${passed ? 'test-pass' : 'test-fail'}">
                                ${passed ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}<br>
                                æœŸæœ›: ${expectedDisplay} (${test.expected}åˆ†é’Ÿ)<br>
                                å®é™…: ${display} (${actual}åˆ†é’Ÿ)
                            </div>
                        </div>
                    `;

                    if (test.isWorkdayOverride) {
                        delete recorder.workdayOverrides[test.date];
                    }
                });

                html += `</div>`;
            });

            resultsDiv.innerHTML = html;

            // æ˜¾ç¤ºæ€»ç»“
            const summaryDiv = document.getElementById('summary');
            const statsDiv = document.getElementById('summaryStats');
            summaryDiv.style.display = 'block';
            statsDiv.innerHTML = `
                æ€»è®¡: ${passedTests + failedTests} ä¸ªæµ‹è¯•<br>
                âœ… é€šè¿‡: ${passedTests} ä¸ª<br>
                âŒ å¤±è´¥: ${failedTests} ä¸ª<br>
                é€šè¿‡ç‡: ${((passedTests / (passedTests + failedTests)) * 100).toFixed(1)}%
            `;
        }

        // é¡µé¢åŠ è½½åè‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.addEventListener('DOMContentLoaded', runTests);
    </script>
</body>
</html>